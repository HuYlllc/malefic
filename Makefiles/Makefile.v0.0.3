release_version := v0.0.3
build_type :=
build_version := community
target_triple := x86_64-unknown-linux-musl
malefic_modules_features :=

# 判断 target_triple 并设置相应的 cargo build 命令
define build_cmd
    ifeq ($(target_triple), x86_64-win7-windows-msvc)
        cargo +nightly build --target x86_64-win7-windows-msvc -Z build-std=std,panic_abort --release -p malefic
    else
        cargo build --release -p malefic --target $(target_triple)
    endif
endef

base:
	if [ ! -f malefic_mutant ]; then wget -O malefic_mutant https://github.com/chainreactors/malefic/releases/download/$(release_version)/malefic-mutant-x86_64-unknown-linux-musl; fi
	chmod +x malefic_mutant
	wget https://github.com/chainreactors/malefic/releases/download/v0.0.3/resources.zip
	unzip resources.zip -d resources

beacon: base
	docker run -v "$(PWD)/cache/registry:/root/cargo/registry" -v "$(PWD)/cache/git:/root/cargo/git" -v "$(PWD):/root/src" --rm -it \
 	  ghcr.io/chainreactors/$(target_triple):nightly-2023-09-18-latest bash -c "./malefic_mutant generate beacon && $(build_cmd)"

bind: base
	docker run -v "$(PWD)/cache/registry:/root/cargo/registry" -v "$(PWD)/cache/git:/root/cargo/git" -v "$(PWD):/root/src" --rm -it \
 	  ghcr.io/chainreactors/$(target_triple):nightly-2023-09-18-latest bash -c "./malefic_mutant generate bind && $(build_cmd)"

prelude: base
	docker run -v "$(PWD)/cache/registry:/root/cargo/registry" -v "$(PWD)/cache/git:/root/cargo/git" -v "$(PWD):/root/src" --rm -it \
 	  ghcr.io/chainreactors/$(target_triple):nightly-2023-09-18-latest bash -c "./malefic_mutant generate prelude autorun.yaml && $(build_cmd)"

pulse: base
	docker run -v "$(PWD)/cache/registry:/root/cargo/registry" -v "$(PWD)/cache/git:/root/cargo/git" -v "$(PWD):/root/src" --rm -it \
 	  ghcr.io/chainreactors/$(target_triple):nightly-2023-09-18-latest bash -c "./malefic_mutant generate pulse x64 win && $(build_cmd)"

modules: base
	docker run -v "$(PWD)/cache/registry:/root/cargo/registry" -v "$(PWD)/cache/git:/root/cargo/git" -v "$(PWD):/root/src" --rm -it \
 	  ghcr.io/chainreactors/$(target_triple):nightly-2023-09-18-latest bash -c "./malefic_mutant generate modules && $(build_cmd)"
